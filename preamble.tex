% Version: 1.6
% Date: 2023-10-21
% Description: PurdueX Introduction to Quantum Science & Technology Section C Notes and Homework Preamble
% Author: Chevan Nanayakkara
% Changelog:
% - Version 1.6:
%   - Moved user-specific configuration to the top of the preamble for easier modification.

\documentclass[10pt,letterpaper]{article}
\usepackage[left=0.5in,right=0.5in,top=0.5in,bottom=0.5in]{geometry}

% ====================
% User Configuration
% ====================
% Maximum number of interludes
\newcommand{\maxinterludes}{5}
% Sequence of PDF files
\newcommand{\pdffiles}{PDF/Lecture_Notes-Section_C}
% Number of pages for each PDF
\newcommand{\pdfpages}{95}
% ====================
% End of User Configuration
% ====================

% Graphics and design
\usepackage{graphicx}
\usepackage{scrlayer-scrpage}
\usepackage{xcolor}
\usepackage{cancel}

% Math support
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{mathrsfs}

% List support
\usepackage{enumitem}

% LaTeX3 programming and syntax
\usepackage{xparse}
\usepackage{expl3}

% Hyperlinking and enhanced PDF support
\usepackage[bookmarksopen=true, colorlinks=true, linkcolor=blue, citecolor=blue, urlcolor=blue]{hyperref}
\usepackage{pdfpages}

% Define page style
\pagestyle{scrheadings}
\clearpairofpagestyles

\ExplSyntaxOn

% Global variables and sequences
\int_new:N \g_max_interludes_int
\int_gset:Nn \g_max_interludes_int {5}
\newcounter{currentslide}
\newcounter{totalpdfpages}
\newcommand{\currentpdfname}{}
\seq_new:N \g_pdf_files_seq
\seq_new:N \g_pdf_pages_seq
\seq_gset_from_clist:Nn \g_pdf_files_seq {PDF/Lecture_Notes-Section_C}
\seq_gset_from_clist:Nn \g_pdf_pages_seq {95}
\prop_new:N \g_slide_annotations_prop
\prop_new:N \g_interludes_prop
\tl_new:N \l_slideinterlude_content_tl % renamed from \l_tmpa_tl to avoid conflict
\tl_new:N \l_slideannotate_content_tl % for storing the content of slideannotate


\NewDocumentCommand{\setcurrentpdfname}{m}
{
  \renewcommand{\currentpdfname}{#1}
}

\NewDocumentEnvironment{slideannotate}{m +b}
 {
  \tl_set:Nn \l_slideannotate_content_tl {#2}
  \prop_gput:NnV \g_slide_annotations_prop {#1} \l_slideannotate_content_tl
 }
 {}

\NewDocumentEnvironment{slideinterlude}{m +b}
 {
  \tl_set:Nn \l_slideinterlude_content_tl {#2}
  \prop_gput:NnV \g_interludes_prop {#1} \l_slideinterlude_content_tl 
 }
 {}


\cs_new_protected:Nn \__render_slide:nn
{
  \__include_pdf:nn {#1} {\currentpdfname}
  \__render_annotation:nn {#1} {#2}
}

\cs_new_protected:Nn \__render_annotation:nn
{
  \begin{center}
    \begin{minipage}{\textwidth}
      \large
      \textbf{Annotation~for~\textcolor{red}{Slide~#1}~of~\arabic{totalpdfpages}:}
      \textit{\currentpdfname}
      \prop_item:Nn \g_slide_annotations_prop {#2-#1}
    \end{minipage}
  \end{center}
}

\cs_new_protected:Nn \__include_pdf:nn
{
  \begin{center}
    \includegraphics[page=#1, width=\textwidth]{#2}
  \end{center}
}

\cs_new_protected:Nn \__render_interlude:nn
{
  \prop_if_in:NnT \g_interludes_prop {#1-#2}
  {
    \clearpage
    \begin{center}
      \large
      \textbf{Interlude~Location:~\textcolor{red}{#1-#2}}
    \end{center}
    \vspace{1em}
    \prop_item:Nn \g_interludes_prop {#1-#2}
  }
}

\NewDocumentCommand{\annotatepdf}{m}
{
  \setcounter{totalpdfpages}{\seq_item:Nn \g_pdf_pages_seq {#1}}
  \setcurrentpdfname{\seq_item:Nn \g_pdf_files_seq {#1}}

  \int_step_inline:nn {\seq_item:Nn \g_pdf_pages_seq {#1}}
  {
    \clearpage
    \setcounter{currentslide}{##1}
    \__render_slide:nn {##1} {#1}
    \thispagestyle{scrheadings}

    % Check for interludes
    \prop_if_in:NnT \g_interludes_prop {#1-##1}
    {
      \__render_interlude:nn {#1} {##1}
    }
  }
}


\cs_new_protected:Nn \__set_total_pages_and_pdf_name:n
{
  \setcounter{totalpdfpages}{\seq_item:Nn \g_pdf_pages_seq {#1}}
  \setcurrentpdfname{\seq_item:Nn \g_pdf_files_seq {#1}}
}

\cs_new_protected:Nn \__process_interludes:nn
{
  \int_step_inline:nn {\g_max_interludes_int}
  {
    \__render_interlude:nn {#1-##1} {#2}
  }
}

\ExplSyntaxOff

\ofoot{Page \pagemark}
\ohead{\thetitle}

\title{Introduction to Quantum Science \& Technology Section C Notes and Homework}
\author{Chevan Nanayakkara}
\date{October 2023}

\NewExpandableDocumentCommand{\thetitle}{}{\csuse{title}}
\thispagestyle{scrheadings}

% End of preamble

