% LaTeX3, pdfLaTeX
% Version: 2.2
% Date: 2023-11-06
% Changelog:
% - Version 2.2:
%   - Moved title, author, and date to user-specified variables.
%   - Ensured that full text is used without stripping spaces.
%   - Reorganized the code and added comments to sections for clarity
% - Version 2.1:
%   - Added syntax highlighting and line numbers for included Python code blocks.
%   - Language formatting is auto-detected by the included file's extension.
% - Version 2.0:
%   - Added functionality to include multi-line code from an external file into the {slideinterlude} environment.
% - Version 1.9.1:
%   - Fixed a bug in \labelgraphics where the interlude format was not preserved
% - Version 1.9:
%   - Introduced \suppressslide{x-y} command to exclude specific slides from being displayed.
% - Version 1.8:
%   - Introduced \labelgraphics to auto-display image filename below the image.
% - Version 1.7.1:
%   - Changed interlude slide labels to: "Slide Interlude"
% - Version 1.7:
%   - Added auto-detection of the number of pages in PDFs.
% - Version 1.6:
%   - Grouped user-specified variables.
%   - Cleaned up code and eliminated redundant elements.
% - Version 1.5:
%   - Converted \begin{slideannotate} command to slideannotate environment.

% User configuration section
% --------------------------
% Document metadata
\newcommand{\MyTitle}{UC San DiegoX Python for Data Science, Week 4: Pandas}
\newcommand{\MyAuthor}{Chevan Nanayakkara}
\newcommand{\MyDate}{November 2023}

% User variables



% Define expandable commands for title, author, and date to use in headers/footers
\NewExpandableDocumentCommand{\thetitle}{}{\MyTitle}
\NewExpandableDocumentCommand{\theauthor}{}{\MyAuthor}
\NewExpandableDocumentCommand{\thedate}{}{\MyDate}



% Document class and packages
\documentclass[10pt,letterpaper]{article}
\usepackage[left=0.5in,right=0.5in,top=0.5in,bottom=0.5in]{geometry}

% Graphics and design
\usepackage{graphicx}
\usepackage{scrlayer-scrpage}
\usepackage{xcolor}
\usepackage{cancel}
\usepackage{listings} % For code formatting

% Define custom colors
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\definecolor{codeblue}{rgb}{0.25,0.5,0.5}

% Configure listings for Python code
\lstdefinestyle{pythonstyle}{
  language=Python,
  backgroundcolor=\color{backcolour},
  commentstyle=\color{codegreen},
  keywordstyle=\color{codeblue},
  numberstyle=\tiny\color{codegray},
  stringstyle=\color{codepurple},
  basicstyle=\ttfamily\small,
  breakatwhitespace=false,         
  breaklines=true,                 
  captionpos=b,                    
  keepspaces=true,                 
  numbers=left,                    
  numbersep=5pt,                  
  showspaces=false,                
  showstringspaces=false,
  showtabs=false,                  
  tabsize=2
}

\lstset{style=pythonstyle}

% Math support
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{mathrsfs}

% List support
\usepackage{enumitem}

% LaTeX3 programming and syntax
\usepackage{xparse}
\usepackage{expl3}

% Hyperlinking and enhanced PDF support
\usepackage[bookmarksopen=true, colorlinks=true, linkcolor=blue, citecolor=blue, urlcolor=blue]{hyperref}
\usepackage{pdfpages}

% Define page style
% Set the document metadata using the user-specified variables
\title{\MyTitle}
\author{\MyAuthor}
\date{\MyDate}

% Page style settings
\pagestyle{scrheadings}
\clearpairofpagestyles % Clear header and footer
\ifoot{\MyTitle} % Set document name in the footer on the left
\ofoot{\thepage} % Set page number in the footer on the right

% LaTeX3 programming and syntax
\ExplSyntaxOn

% User-specified variables and sequences
\int_new:N \g_max_interludes_int
\int_gset:Nn \g_max_interludes_int {5}
\seq_new:N \g_pdf_files_seq
\seq_gset_from_clist:Nn \g_pdf_files_seq {W3_L1_V1_why_jupyter.pdf,W3_L2_V1_why_numpy.pdf,UNIX-Jupyter-Notebook-Example.pdf,03_Numpy_Notebook.pdf,Satellite_Image_Analysis_using_numpy.pdf}

% Internal counters, properties, and tokens
\newcounter{currentslide}
\newcounter{totalpdfpages}
\newcommand{\currentpdfname}{}
\prop_new:N \g_slide_annotations_prop
\prop_new:N \g_interludes_prop
\tl_new:N \l_slideinterlude_content_tl
\tl_new:N \l_slideannotate_content_tl
\prop_new:N \g_suppressed_slides_prop % Property to store suppressed slides
\seq_new:N \g_pdf_pages_seq % Creates a global sequence to hold items which store the number of pages of different PDF documents included in the LaTeX document


% Auto-detection and handling for different languages based on file extension
\NewDocumentCommand{\includecode}{ O{} m }{
  \lstinputlisting[
    breaklines=true,
    frame=single,
    captionpos=b,
    #1
  ]{#2}
}

% Auto-detection of the number of pages in PDFs
\cs_new:Nn \__get_pdf_pages:n
{
  \pdfximage{#1}
  \seq_gput_right:Nx \g_pdf_pages_seq {\the\pdflastximagepages}
}
\seq_map_inline:Nn \g_pdf_files_seq
{
  \__get_pdf_pages:n {#1}
}

% Define a new command to include graphics with filename label
\NewDocumentCommand{\labelgraphics}{O{} m}
{
  \begin{center}
    \includegraphics[#1]{#2}
  \end{center}
  \par
  \begin{center}
    \begingroup
      \small\ttfamily\detokenize{#2}
    \endgroup
  \end{center}
}


\NewDocumentCommand{\setcurrentpdfname}{m}
{
  \renewcommand{\currentpdfname}{#1}
}

\NewDocumentEnvironment{slideannotate}{m +b}
 {
  \tl_set:Nn \l_slideannotate_content_tl {#2}
  \prop_gput:NnV \g_slide_annotations_prop {#1} \l_slideannotate_content_tl
 }
 {}

\NewDocumentEnvironment{slideinterlude}{m +b}
 {
  \tl_set:Nn \l_slideinterlude_content_tl {#2}
  \prop_gput:NnV \g_interludes_prop {#1} \l_slideinterlude_content_tl 
 }
 {}


\cs_new_protected:Nn \__render_slide:nn
{
  \__include_pdf:nn {#1} {\currentpdfname}
  \__render_annotation:nn {#1} {#2}
}

% We need a new counter for the current PDF index
\newcounter{currentpdfindex}

\cs_new_protected:Nn \__render_annotation:nn
{
  \begin{center}
    \begin{minipage}{\textwidth}
      \large
      \textbf{Annotation~for~\textcolor{red}{Slide~#1}~of~\arabic{totalpdfpages}~of~\arabic{currentpdfindex}:} % Modified here
      \textit{\currentpdfname}
      \prop_item:Nn \g_slide_annotations_prop {#2-#1}
    \end{minipage}
  \end{center}
}

\cs_new_protected:Nn \__include_pdf:nn
{
  \begin{center}
    \includegraphics[page=#1, width=\textwidth]{#2}
  \end{center}
}

\cs_new_protected:Nn \__render_interlude:nn
{
  \prop_if_in:NnT \g_interludes_prop {#1-#2}
  {
    \clearpage  % Ensures the interlude starts on a fresh page
    \begin{center}
      \large
      \textbf{Slide~Interlude:~\textcolor{red}{#1-#2}}
    \end{center}
    \vspace{1em}
    \prop_item:Nn \g_interludes_prop {#1-#2}
  }
}


\NewDocumentCommand{\suppressslide}{m}
{
  \prop_gput:Nnn \g_suppressed_slides_prop {#1} {suppressed}
}

\NewDocumentCommand{\annotatepdf}{m}
{
  \setcounter{currentpdfindex}{#1} % Set the current PDF index
  \setcounter{totalpdfpages}{\seq_item:Nn \g_pdf_pages_seq {#1}}
  \setcurrentpdfname{\seq_item:Nn \g_pdf_files_seq {#1}}

  \int_step_inline:nn {\seq_item:Nn \g_pdf_pages_seq {#1}}
  {
    \prop_if_in:NnF \g_suppressed_slides_prop {#1-##1} % Check if slide is not suppressed
    {
%      \clearpage % Ensure the inserted PDF starts on a fresh page
      \setcounter{currentslide}{##1}
      \__render_slide:nn {##1} {#1}
      \thispagestyle{scrheadings}

      % Check for interludes
      \prop_if_in:NnT \g_interludes_prop {#1-##1}
      {
        \__render_interlude:nn {#1} {##1}
      }
    }
  }
}


\cs_new_protected:Nn \__set_total_pages_and_pdf_name:n
{
  \setcounter{totalpdfpages}{\seq_item:Nn \g_pdf_pages_seq {#1}}
  \setcurrentpdfname{\seq_item:Nn \g_pdf_files_seq {#1}}
}

\cs_new_protected:Nn \__process_interludes:nn
{
  \int_step_inline:nn {\g_max_interludes_int}
  {
    \__render_interlude:nn {#1-##1} {#2}
  }
}

\ExplSyntaxOff


% End of preamble
\thispagestyle{scrheadings}

% End of preamble

